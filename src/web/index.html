<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Store Manager</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 1.5rem;
            background: #111827;
            color: #e5e7eb;
        }
        h1 {
            text-align: center;
            margin-bottom: 1rem;
        }
        .top-bar {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.4rem;
            border: 1px solid #4b5563;
            background: #1f2937;
            color: #e5e7eb;
            cursor: pointer;
        }
        button.active {
            background: #2563eb;
            border-color: #2563eb;
        }
        button:hover {
            background: #374151;
        }
        .toggle-row {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .card {
            max-width: 900px;
            margin: 0 auto;
            background: #020617;
            border-radius: 0.5rem;
            padding: 1rem 1.25rem;
            border: 1px solid #1f2937;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.75rem 1.5rem;
        }
        label {
            display: flex;
            flex-direction: column;
            font-size: 0.9rem;
            gap: 0.2rem;
        }
        input, select, textarea {
            padding: 0.3rem 0.4rem;
            border-radius: 0.35rem;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
            font-size: 0.9rem;
        }
        textarea {
            resize: vertical;
            min-height: 3rem;
        }
        .section-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }
        pre {
            background: #020617;
            border-radius: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #1f2937;
            overflow: auto;
            font-size: 0.85rem;
        }
        .small {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .result-item {
            border-bottom: 1px solid #374151;
            padding: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-actions {
            display: flex;
            gap: 0.5rem;
        }
        .result-actions button {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
        }
        .delete-btn {
            background: #7f1d1d;
            border-color: #991b1b;
        }
        .delete-btn:hover {
            background: #991b1b;
        }
        .edit-btn {
            background: #0f766e;
            border-color: #115e59;
        }
        .edit-btn:hover {
            background: #115e59;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .results-header h2 {
            margin: 0;
        }
    </style>
</head>
<body>
<h1>Store Manager</h1>

<div class="top-bar">
    <button id="mode-add-btn" class="active" onclick="setMode('add')">‚ûï Add / Edit</button>
    <button id="mode-search-btn" onclick="setMode('search')">üîç Search</button>
</div>

<div class="toggle-row">
    <label>
        <input type="radio" name="entity" value="employee" checked onchange="setEntity('employee')">
        Employee
    </label>
    <label>
        <input type="radio" name="entity" value="product" onchange="setEntity('product')">
        Product
    </label>
</div>

<div class="card">

    <!-- ADD/EDIT EMPLOYEE -->
    <div id="employee-add-section">
        <div class="section-title" id="employee-form-title">Add Employee</div>
        <form id="employee-add-form">
            <input type="hidden" id="employee-add-id"> <!-- Hidden ID for updates -->
            <div class="form-grid">
                <label>Name
                    <input id="employee-add-name" type="text" placeholder="Denis">
                </label>
                <label>Surname
                    <input id="employee-add-surname" type="text" placeholder="Urandik">
                </label>
                <label>Position
                    <input id="employee-add-position" type="text" placeholder="CEO">
                </label>
                <label>Department
                    <input id="employee-add-department" type="text" placeholder="IT">
                </label>
                <label>Shift
                    <input id="employee-add-shift" type="text" placeholder="Day / Night">
                </label>
                <label>Salary
                    <input id="employee-add-salary" type="number" step="0.01" placeholder="1500">
                </label>
                <label>Phone number
                    <input id="employee-add-phone" type="text" placeholder="0903 000 000">
                </label>
                <label>Email
                    <input id="employee-add-email" type="email" placeholder="email@example.com">
                </label>
                <label>Status
                    <select id="employee-add-status">
                        <option value="">(None)</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </label>
                <label>Note
                    <textarea id="employee-add-note" placeholder="Notes..."></textarea>
                </label>
                <label>Hire date
                    <input id="employee-add-hire-date" type="date">
                    <span class="small">Format: YYYY-MM-DD</span>
                </label>
            </div>
            <div class="actions">
                <button type="submit" id="employee-submit-btn">Save employee</button>
                <button type="button" onclick="resetForm('employee-add-form')">Reset</button>
                <button type="button" id="employee-cancel-edit" style="display:none" onclick="cancelEdit()">Cancel Edit</button>
            </div>
        </form>
    </div>


    <div id="employee-search-section" style="display:none">
        <div class="section-title">Search Employees</div>
        <form id="employee-search-form">
            <div class="form-grid">
                <label>ID
                    <input id="employee-search-id" type="number">
                </label>
                <label>Name
                    <input id="employee-search-name" type="text">
                </label>
                <label>Surname
                    <input id="employee-search-surname" type="text">
                </label>
                <label>Position
                    <input id="employee-search-position" type="text">
                </label>
                <label>Department
                    <input id="employee-search-department" type="text">
                </label>
                <label>Shift
                    <input id="employee-search-shift" type="text">
                </label>
                <label>Salary
                    <input id="employee-search-salary" type="number" step="0.01">
                </label>
                <label>Phone number
                    <input id="employee-search-phone" type="text">
                </label>
                <label>Email
                    <input id="employee-search-email" type="email">
                </label>
                <label>Status
                    <select id="employee-search-status">
                        <option value="">(Any)</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </label>
                <label>Note contains
                    <input id="employee-search-note" type="text">
                </label>
                <label>Hire date
                    <input id="employee-search-hire-date" type="date">
                </label>
            </div>
            <div class="actions">
                <button type="submit">Search employees</button>
                <button type="button" onclick="loadAllEmployees()">Load all employees</button>
                <button type="button" onclick="resetForm('employee-search-form')">Reset</button>
            </div>
        </form>
    </div>


    <div id="product-add-section" style="display:none">
        <div class="section-title" id="product-form-title">Add Product</div>
        <form id="product-add-form">
            <input type="hidden" id="product-add-id">
            <div class="form-grid">
                <label>Name
                    <input id="product-add-name" type="text">
                </label>
                <label>Category
                    <input id="product-add-category" type="text">
                </label>
                <label>Quantity
                    <input id="product-add-quantity" type="number">
                </label>
                <label>Status
                    <select id="product-add-status">
                        <option value="">(None)</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </label>
                <label>Bar code
                    <input id="product-add-barcode" type="number">
                </label>
                <label>Cost price
                    <input id="product-add-cost-price" type="number" step="0.01">
                </label>
                <label>Sell price
                    <input id="product-add-sell-price" type="number" step="0.01">
                </label>
                <label>Description
                    <textarea id="product-add-description"></textarea>
                </label>
                <label>Brand
                    <input id="product-add-brand" type="text">
                </label>
                <label>Supplier
                    <input id="product-add-supplier" type="text">
                </label>
                <label>Employee ID
                    <input id="product-add-employee-id" type="number">
                </label>
                <label>Date added
                    <input id="product-add-date-added" type="date">
                </label>
                <label>Date removed
                    <input id="product-add-date-remove" type="date">
                </label>
            </div>
            <div class="actions">
                <button type="submit" id="product-submit-btn">Save product</button>
                <button type="button" onclick="resetForm('product-add-form')">Reset</button>
                <button type="button" id="product-cancel-edit" style="display:none" onclick="cancelEdit()">Cancel Edit</button>
            </div>
        </form>
    </div>


    <div id="product-search-section" style="display:none">
        <div class="section-title">Search Products</div>
        <form id="product-search-form">
            <div class="form-grid">
                <label>ID
                    <input id="product-search-id" type="number">
                </label>
                <label>Name
                    <input id="product-search-name" type="text">
                </label>
                <label>Category
                    <input id="product-search-category" type="text">
                </label>
                <label>Quantity
                    <input id="product-search-quantity" type="number">
                </label>
                <label>Status
                    <select id="product-search-status">
                        <option value="">(Any)</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </label>
                <label>Bar code
                    <input id="product-search-barcode" type="number">
                </label>
                <label>Cost price
                    <input id="product-search-cost-price" type="number" step="0.01">
                </label>
                <label>Sell price
                    <input id="product-search-sell-price" type="number" step="0.01">
                </label>
                <label>Description contains
                    <input id="product-search-description" type="text">
                </label>
                <label>Brand
                    <input id="product-search-brand" type="text">
                </label>
                <label>Supplier
                    <input id="product-search-supplier" type="text">
                </label>
                <label>Employee ID
                    <input id="product-search-employee-id" type="number">
                </label>
                <label>Date added
                    <input id="product-search-date-added" type="date">
                </label>
                <label>Date removed
                    <input id="product-search-date-remove" type="date">
                </label>
            </div>
            <div class="actions">
                <button type="submit">Search products</button>
                <button type="button" onclick="loadAllProducts()">Load all products</button>
                <button type="button" onclick="resetForm('product-search-form')">Reset</button>
            </div>
        </form>
    </div>
</div>

<div class="results-header">
    <h2>Results</h2>
    <button onclick="exportResults()">Export Results to JSON</button>
</div>
<div id="results-container"></div>
<pre id="results-raw" style="display:none"></pre>

<script>
    let currentMode = 'add';
    let currentEntity = 'employee';
    let lastSearchResults = [];

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('mode-add-btn').classList.toggle('active', mode === 'add');
        document.getElementById('mode-search-btn').classList.toggle('active', mode === 'search');


        if (mode === 'add') {
            cancelEdit();
        }

        updateVisibleSections();
        clearResults();
    }

    function setEntity(entity) {
        currentEntity = entity;
        cancelEdit();
        updateVisibleSections();
        clearResults();
    }

    function updateVisibleSections() {
        const sections = [
            'employee-add-section',
            'employee-search-section',
            'product-add-section',
            'product-search-section',
        ];
        sections.forEach(id => document.getElementById(id).style.display = 'none');

        if (currentMode === 'add' && currentEntity === 'employee') {
            document.getElementById('employee-add-section').style.display = 'block';
        } else if (currentMode === 'search' && currentEntity === 'employee') {
            document.getElementById('employee-search-section').style.display = 'block';
        } else if (currentMode === 'add' && currentEntity === 'product') {
            document.getElementById('product-add-section').style.display = 'block';
        } else if (currentMode === 'search' && currentEntity === 'product') {
            document.getElementById('product-search-section').style.display = 'block';
        }
    }

    function clearResults() {
        document.getElementById('results-container').innerHTML = '';
        document.getElementById('results-raw').textContent = '';
        lastSearchResults = [];
    }

    function resetForm(formId) {
        document.getElementById(formId).reset();

        if (formId.includes('search')) {
            clearResults();
        }
    }

    function exportResults() {
        if (!lastSearchResults || lastSearchResults.length === 0) {
            alert("No results to export.");
            return;
        }

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(lastSearchResults, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", currentEntity + "_search_results.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }



    function buildEmployeePayload(prefix) {
        const payload = {};
        const get = id => document.getElementById(prefix + '-' + id);

        const idEl = get('id');
        if (prefix.includes('search') && idEl && idEl.value.trim() !== '') {
            const v = parseInt(idEl.value.trim(), 10);
            if (!Number.isNaN(v)) payload.id = v;
        }

        const name = get('name')?.value.trim();
        if (name) payload.name = name;

        const surname = get('surname')?.value.trim();
        if (surname) payload.surname = surname;

        const position = get('position')?.value.trim();
        if (position) payload.position = position;

        const department = get('department')?.value.trim();
        if (department) payload.department = department;

        const shift = get('shift')?.value.trim();
        if (shift) payload.shift = shift;

        const salaryStr = get('salary')?.value.trim();
        if (salaryStr) {
            const s = parseFloat(salaryStr);
            if (!Number.isNaN(s)) payload.salary = s;
        }

        const phone = get('phone')?.value.trim();
        if (phone) payload.phone_number = phone;

        const email = get('email')?.value.trim();
        if (email) payload.email = email;

        const statusEl = get('status');
        if (statusEl) {
            if (statusEl.value === 'active') payload.status = true;
            else if (statusEl.value === 'inactive') payload.status = false;
        }

        const note = get('note')?.value.trim();
        if (note) payload.note = note;

        const hireDate = get('hire-date')?.value;
        if (hireDate) payload.hire_date = hireDate;

        return payload;
    }

    function buildProductPayload(prefix) {
        const payload = {};
        const get = id => document.getElementById(prefix + '-' + id);

        const idEl = get('id');
        if (prefix.includes('search') && idEl && idEl.value.trim() !== '') {
            const v = parseInt(idEl.value.trim(), 10);
            if (!Number.isNaN(v)) payload.id = v;
        }

        const name = get('name')?.value.trim();
        if (name) payload.name = name;

        const category = get('category')?.value.trim();
        if (category) payload.category = category;

        const quantityStr = get('quantity')?.value.trim();
        if (quantityStr) {
            const q = parseInt(quantityStr, 10);
            if (!Number.isNaN(q)) payload.quantity = q;
        }

        const statusEl = get('status');
        if (statusEl) {
            if (statusEl.value === 'active') payload.status = true;
            else if (statusEl.value === 'inactive') payload.status = false;
        }

        const barcodeStr = get('barcode')?.value.trim();
        if (barcodeStr) {
            const b = parseInt(barcodeStr, 10);
            if (!Number.isNaN(b)) payload.bar_code = b;
        }

        const costStr = get('cost-price')?.value.trim();
        if (costStr) {
            const c = parseFloat(costStr);
            if (!Number.isNaN(c)) payload.cost_price = c;
        }

        const sellStr = get('sell-price')?.value.trim();
        if (sellStr) {
            const s = parseFloat(sellStr);
            if (!Number.isNaN(s)) payload.sell_price = s;
        }

        const description = get('description')?.value.trim();
        if (description) payload.description = description;

        const brand = get('brand')?.value.trim();
        if (brand) payload.brand = brand;

        const supplier = get('supplier')?.value.trim();
        if (supplier) payload.supplier = supplier;

        const empIdStr = get('employee-id')?.value.trim();
        if (empIdStr) {
            const e = parseInt(empIdStr, 10);
            if (!Number.isNaN(e)) payload.employee_id = e;
        }

        const dateAdded = get('date-added')?.value;
        if (dateAdded) payload.date_added = dateAdded;

        const dateRemove = get('date-remove')?.value;
        if (dateRemove) payload.date_remove = dateRemove;

        return payload;
    }

    // --- Form Submission Handlers ---

    document.getElementById('employee-add-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = buildEmployeePayload('employee-add');
        const id = document.getElementById('employee-add-id').value;

        let url = '/employees';
        let method = 'POST';

        if (id) {
            url = `/employees/${id}`;
            method = 'PUT';
        }

        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload),
        });

        if (res.ok) {
            alert(id ? 'Employee updated.' : 'Employee saved.');
            if (id) cancelEdit();
            else e.target.reset();
        } else {
            alert('Error saving employee');
        }
    });

    document.getElementById('product-add-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = buildProductPayload('product-add');
        const id = document.getElementById('product-add-id').value;

        let url = '/products';
        let method = 'POST';

        if (id) {
            url = `/products/${id}`;
            method = 'PUT';
        }

        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload),
        });

        if (res.ok) {
            alert(id ? 'Product updated.' : 'Product saved.');
            if (id) cancelEdit();
            else e.target.reset();
        } else {
            alert('Error saving product');
        }
    });

    document.getElementById('employee-search-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = buildEmployeePayload('employee-search');
        const res = await fetch('/employees/search', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload),
        });
        const data = await res.json();
        renderResults(data, 'employee');
    });

    document.getElementById('product-search-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = buildProductPayload('product-search');
        const res = await fetch('/products/search', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload),
        });
        const data = await res.json();
        renderResults(data, 'product');
    });

    async function loadAllEmployees() {
        const res = await fetch('/employees');
        const data = await res.json();
        renderResults(data, 'employee');
    }

    async function loadAllProducts() {
        const res = await fetch('/products');
        const data = await res.json();
        renderResults(data, 'product');
    }



    function renderResults(data, type) {
        lastSearchResults = data;
        const container = document.getElementById('results-container');
        container.innerHTML = '';

        if (!data || data.length === 0) {
            container.innerHTML = '<div style="padding:1rem; color:#9ca3af">No results found.</div>';
            return;
        }

        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'result-item';

            const info = document.createElement('div');
            if (type === 'employee') {
                info.textContent = `ID: ${item.id} | ${item.name || ''} ${item.surname || ''} | ${item.position || ''}`;
            } else {
                info.textContent = `ID: ${item.id} | ${item.name || ''} | ${item.category || ''} | Qty: ${item.quantity || 0}`;
            }

            const actions = document.createElement('div');
            actions.className = 'result-actions';

            const editBtn = document.createElement('button');
            editBtn.className = 'edit-btn';
            editBtn.textContent = 'Edit';
            editBtn.onclick = () => startEdit(item, type);

            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn';
            delBtn.textContent = 'Delete';
            delBtn.onclick = () => deleteItem(item.id, type);

            actions.appendChild(editBtn);
            actions.appendChild(delBtn);

            div.appendChild(info);
            div.appendChild(actions);
            container.appendChild(div);
        });
    }

    async function deleteItem(id, type) {
        if (!confirm('Are you sure you want to delete this item?')) return;

        const endpoint = type === 'employee' ? `/employees/${id}` : `/products/${id}`;
        const res = await fetch(endpoint, { method: 'DELETE' });

        if (res.ok) {
            // Refresh the list
            if (type === 'employee') document.getElementById('employee-search-form').dispatchEvent(new Event('submit'));
            else document.getElementById('product-search-form').dispatchEvent(new Event('submit'));
        } else {
            alert('Error deleting item');
        }
    }

    function startEdit(item, type) {

        setMode('add');
        setEntity(type);


        if (type === 'employee') {
            document.getElementById('employee-form-title').textContent = `Edit Employee (ID: ${item.id})`;
            document.getElementById('employee-submit-btn').textContent = 'Update Employee';
            document.getElementById('employee-cancel-edit').style.display = 'inline-block';
            document.getElementById('employee-add-id').value = item.id;

            const set = (id, val) => { if(val !== undefined && val !== null) document.getElementById('employee-add-'+id).value = val; };

            set('name', item.name);
            set('surname', item.surname);
            set('position', item.position);
            set('department', item.department);
            set('shift', item.shift);
            set('salary', item.salary);
            set('phone', item.phone_number);
            set('email', item.email);
            set('note', item.note);
            set('hire-date', item.hire_date);

            if (item.status === true) document.getElementById('employee-add-status').value = 'active';
            else if (item.status === false) document.getElementById('employee-add-status').value = 'inactive';

        } else {
            document.getElementById('product-form-title').textContent = `Edit Product (ID: ${item.id})`;
            document.getElementById('product-submit-btn').textContent = 'Update Product';
            document.getElementById('product-cancel-edit').style.display = 'inline-block';
            document.getElementById('product-add-id').value = item.id;

            const set = (id, val) => { if(val !== undefined && val !== null) document.getElementById('product-add-'+id).value = val; };

            set('name', item.name);
            set('category', item.category);
            set('quantity', item.quantity);
            set('barcode', item.bar_code);
            set('cost-price', item.cost_price);
            set('sell-price', item.sell_price);
            set('description', item.description);
            set('brand', item.brand);
            set('supplier', item.supplier);
            set('employee-id', item.employee_id);
            set('date-added', item.date_added);
            set('date-remove', item.date_remove);

            if (item.status === true) document.getElementById('product-add-status').value = 'active';
            else if (item.status === false) document.getElementById('product-add-status').value = 'inactive';
        }
    }

    function cancelEdit() {

        if (currentEntity === 'employee') {
            document.getElementById('employee-form-title').textContent = 'Add Employee';
            document.getElementById('employee-submit-btn').textContent = 'Save Employee';
            document.getElementById('employee-cancel-edit').style.display = 'none';
            document.getElementById('employee-add-id').value = '';
            document.getElementById('employee-add-form').reset();
        } else {
            document.getElementById('product-form-title').textContent = 'Add Product';
            document.getElementById('product-submit-btn').textContent = 'Save Product';
            document.getElementById('product-cancel-edit').style.display = 'none';
            document.getElementById('product-add-id').value = '';
            document.getElementById('product-add-form').reset();
        }
    }


    updateVisibleSections();
</script>

</body>
</html>
